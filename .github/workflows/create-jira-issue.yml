name: Create Jira issue
on:
  issues:
    types:
      - opened

permissions:
  contents: write
  issues: write

jobs:
  create-issue:
    name: Create Jira issue
    runs-on: ubuntu-latest
    steps:
      - name: Login
        uses: atlassian/gajira-login@v3
        env:
          JIRA_BASE_URL: ${{ secrets.JIRA_BASE_URL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}

      - name: Checkout main code
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Issue Parser
        uses: stefanbuck/github-issue-parser@v3
        id: issue-parser
        with:
          template-path: .github/ISSUE_TEMPLATE/issue-form.yml
          
      - name: Map Assignee
        id: map-assignee
        run: |
          ASSIGNEE="${{ steps.issue-parser.outputs.issueparser_assignee }}"
          
          case "$ASSIGNEE" in
            "YB")
              ACCOUNT_ID="712020:3adc9a27-acea-40e9-b035-2daa43129040"
              ;;
            "Seyeon Kim")
              ACCOUNT_ID="712020:3b45f2cf-64f0-405b-9c41-e0d6fbec4c90"
              ;;
            *)
              ACCOUNT_ID=""
              ;;
          esac
          
          echo "assignee_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT

      - name: Prepare Jira Fields
        id: jira-fields
        run: |
          ASSIGNEE_ID="${{ steps.map-assignee.outputs.assignee_id }}"
          PARENT_KEY="${{ steps.issue-parser.outputs.issueparser_parentKey }}"
          
          if [ -n "$ASSIGNEE_ID" ]; then
            # assignee 있음
            FIELDS=$(cat <<EOF
          {
            "parent": {"key": "$PARENT_KEY"},
            "assignee": {"accountId": "$ASSIGNEE_ID"}
          }
          EOF
            )
          else
            # assignee 없음
            FIELDS=$(cat <<EOF
          {
            "parent": {"key": "$PARENT_KEY"}
          }
          EOF
            )
          fi
          
          echo "fields<<EOF" >> $GITHUB_OUTPUT
          echo "$FIELDS" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create Subtask
        id: create
        uses: atlassian/gajira-create@v3
        with:
          project: LUV
          issuetype: 하위 작업
          summary: '[BE] ${{ github.event.issue.title }}'
          description: |
            Github Issue Link: ${{ github.event.issue.html_url }}
            
            ${{ github.event.issue.body }}
          fields: ${{ steps.jira-fields.outputs.fields }}

      - name: Checkout develop code
        uses: actions/checkout@v4
        with:
          ref: develop

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Create branch
        run: |
          ISSUE_NUMBER="${{ steps.create.outputs.issue }}"
          BRANCH_TYPE="${{ steps.issue-parser.outputs.issueparser_branchType }}"
          
          if [ -z "$BRANCH_TYPE" ] || [ "$BRANCH_TYPE" = "_No response_" ]; then
            BRANCH_TYPE="feature"
          fi
          
          BRANCH_NAME="${BRANCH_TYPE}/${ISSUE_NUMBER}"
          git checkout -b "${BRANCH_NAME}"
          git push origin "${BRANCH_NAME}"

      - name: Update issue title
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'update-issue'
          token: ${{ secrets.GITHUB_TOKEN }}
          title: '[${{ steps.create.outputs.issue }}] ${{ github.event.issue.title }}'

      - name: Map GitHub Username
        id: map-github
        run: |
          ASSIGNEE="${{ steps.issue-parser.outputs.issueparser_assignee }}"

          case "$ASSIGNEE" in
            "YB")
              GITHUB_USER="zxvm5962"
              ;;
            "Seyeon Kim")
              GITHUB_USER="yonseeee"
              ;;
            *)
              GITHUB_USER=""
              ;;
          esac
          
          echo "github_user=$GITHUB_USER" >> $GITHUB_OUTPUT

      - name: Assign GitHub Issue
        if: steps.map-github.outputs.github_user != ''
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'add-assignees'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          assignees: ${{ steps.map-github.outputs.github_user }}

      - name: Add comment
        uses: actions-cool/issues-helper@v3
        with:
          actions: 'create-comment'
          token: ${{ secrets.GITHUB_TOKEN }}
          issue-number: ${{ github.event.issue.number }}
          body: |
            ## ✅ Jira 연동 완료
            
            **Jira Subtask**: [${{ steps.create.outputs.issue }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.create.outputs.issue }})
            **상위 Story**: [${{ steps.issue-parser.outputs.issueparser_parentKey }}](${{ secrets.JIRA_BASE_URL }}/browse/${{ steps.issue-parser.outputs.issueparser_parentKey }})
            **담당자**: ${{ steps.issue-parser.outputs.issueparser_assignee }}
            **브랜치**: `${{ steps.issue-parser.outputs.issueparser_branchType }}/${{ steps.create.outputs.issue }}`
            
            ---
            ### 🚀 작업 시작하기
            ```bash
            git fetch origin
            git checkout ${{ steps.issue-parser.outputs.issueparser_branchType }}/${{ steps.create.outputs.issue }}
            ```
